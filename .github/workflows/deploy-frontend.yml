name: Deploy Frontend to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    # Esperar a que termine el backend si ambos se ejecutan
    needs: []

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy frontend via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
            host: ${{ secrets.VPS_HOST }}
            username: root
            key: ${{ secrets.VPS_SSH_KEY }}
            script: |
              set -e

              # Configurar PATH para Node.js, npm y PM2
              export PATH=/root/.nvm/versions/node/v24.11.0/bin:$PATH

              echo "[0] Gestionando backend durante deploy de frontend..."
              
              # Detener backend si está corriendo
              echo "Deteniendo backend API..."
              pm2 stop api || true
              pm2 delete api || true
              
              # Liberar puerto 3001
              echo "Liberando puerto 3001..."
              if lsof -i:3001 > /dev/null 2>&1; then
                lsof -ti:3001 | xargs kill -9 || true
                sleep 2
              fi

              echo "[1] Actualizando frontend..."
              cd /var/app/frontend
              
              echo "DEBUG: Estado de git antes de actualizar:"
              git status
              
              echo "DEBUG: Limpiando cambios locales para evitar conflictos..."
              git stash push -m "Auto-stash before deploy $(date)"
              git reset --hard HEAD
              git clean -fd
              
              echo "DEBUG: Pulling desde origin main..."
              git pull origin main

              echo "[2] Instalando dependencias..."
              npm install

              echo "[3] Construyendo build de producción..."
              npm run build

              echo "[4] Configurando Nginx para archivos SEO..."
              
              echo "DEBUG: Verificando configuración actual de Nginx..."
              echo "DEBUG: Contenido actual de /etc/nginx/sites-available/default:"
              cat /etc/nginx/sites-available/default
              echo "DEBUG: =========================="
              
              # Verificar si la configuración SEO ya existe
              if ! grep -q "application/xml" /etc/nginx/sites-available/default 2>/dev/null; then
                echo "DEBUG: Configuración SEO no encontrada, agregando nueva configuración..."
                
                # Crear backup de la configuración actual
                BACKUP_FILE="/etc/nginx/sites-available/default.backup.$(date +%Y%m%d_%H%M%S)"
                cp /etc/nginx/sites-available/default "$BACKUP_FILE"
                echo "DEBUG: Backup creado en: $BACKUP_FILE"
                
                # Crear archivo temporal con configuración
                echo "DEBUG: Creando configuración temporal..."
                echo "    # SEO Configuration for XML and robots.txt" > /tmp/seo-config
                echo "    location = /sitemap.xml {" >> /tmp/seo-config
                echo "        add_header Content-Type \"application/xml; charset=utf-8\";" >> /tmp/seo-config
                echo "        add_header Cache-Control \"public, max-age=86400\";" >> /tmp/seo-config
                echo "        expires 1d;" >> /tmp/seo-config
                echo "    }" >> /tmp/seo-config
                echo "" >> /tmp/seo-config
                echo "    location = /sitemap-videos.xml {" >> /tmp/seo-config
                echo "        add_header Content-Type \"application/xml; charset=utf-8\";" >> /tmp/seo-config
                echo "        add_header Cache-Control \"public, max-age=86400\";" >> /tmp/seo-config
                echo "        expires 1d;" >> /tmp/seo-config
                echo "    }" >> /tmp/seo-config
                echo "" >> /tmp/seo-config
                echo "    location = /sitemap-categories.xml {" >> /tmp/seo-config
                echo "        add_header Content-Type \"application/xml; charset=utf-8\";" >> /tmp/seo-config
                echo "        add_header Cache-Control \"public, max-age=86400\";" >> /tmp/seo-config
                echo "        expires 1d;" >> /tmp/seo-config
                echo "    }" >> /tmp/seo-config
                echo "" >> /tmp/seo-config
                echo "    location = /robots.txt {" >> /tmp/seo-config
                echo "        add_header Content-Type \"text/plain; charset=utf-8\";" >> /tmp/seo-config
                echo "        add_header Cache-Control \"public, max-age=86400\";" >> /tmp/seo-config
                echo "        expires 1d;" >> /tmp/seo-config
                echo "    }" >> /tmp/seo-config
                
                echo "DEBUG: Contenido del archivo de configuración SEO:"
                cat /tmp/seo-config
                echo "DEBUG: =========================="
                
                echo "DEBUG: Intentando insertar configuración con sed..."
                echo "DEBUG: Estrategia alternativa - insertar al final del archivo antes de la última línea"
                
                # Estrategia alternativa: insertar al final del archivo principal
                # Primero verificar las últimas líneas del archivo
                echo "DEBUG: Últimas 10 líneas del archivo actual:"
                tail -10 /etc/nginx/sites-available/default
                
                # Insertar la configuración al final del archivo, antes de la última }
                # Usar un enfoque más directo
                cp /etc/nginx/sites-available/default /tmp/nginx-temp
                
                # Remover la última línea (}), agregar nuestra configuración, y volver a agregar }
                head -n -1 /tmp/nginx-temp > /tmp/nginx-new
                cat /tmp/seo-config >> /tmp/nginx-new
                echo "}" >> /tmp/nginx-new
                
                # Aplicar el nuevo archivo
                mv /tmp/nginx-new /etc/nginx/sites-available/default
                
                echo "DEBUG: Código de salida de la operación: $?"
                echo "DEBUG: Configuración insertada. Nuevo contenido de /etc/nginx/sites-available/default:"
                cat /etc/nginx/sites-available/default
                echo "DEBUG: =========================="
                
                rm -f /tmp/seo-config
                echo "✓ Configuración SEO agregada a Nginx"
                
                # Validar la configuración de Nginx
                echo "DEBUG: Validando configuración de Nginx..."
                if nginx -t; then
                  echo "✓ Configuración de Nginx válida"
                  echo "DEBUG: Recargando Nginx..."
                  systemctl reload nginx
                  echo "DEBUG: Código de salida del reload: $?"
                  echo "✓ Nginx recargado con nueva configuración"
                  
                  echo "DEBUG: Verificando inmediatamente el Content-Type después del reload..."
                  sleep 2
                  echo "DEBUG: Test local de sitemap.xml:"
                  curl -I http://localhost/sitemap.xml 2>/dev/null | grep Content-Type || echo "DEBUG: No se pudo obtener Content-Type local"
                  echo "DEBUG: Test local de robots.txt:"
                  curl -I http://localhost/robots.txt 2>/dev/null | grep Content-Type || echo "DEBUG: No se pudo obtener Content-Type local"
                else
                  echo "❌ Error en configuración de Nginx:"
                  nginx -t
                  echo "DEBUG: Restaurando backup..."
                  cp "$BACKUP_FILE" /etc/nginx/sites-available/default
                  systemctl reload nginx
                  echo "❌ Configuración restaurada, continuando sin cambios SEO"
                fi
              else
                echo "✓ Configuración SEO ya existe en Nginx"
                echo "DEBUG: Verificando qué configuración existe:"
                grep -A 10 -B 2 "application/xml" /etc/nginx/sites-available/default || echo "DEBUG: No se encontró 'application/xml' a pesar de la verificación inicial"
              fi

              echo "[5] Reiniciando backend API..."
              cd /var/app/backend
              
              echo "DEBUG: Estado del directorio backend antes del reinicio:"
              ls -la /var/app/backend/
              
              # Verificar que el entorno virtual existe
              if [ ! -d "venv" ]; then
                echo "DEBUG: Entorno virtual no encontrado, creando..."
                python3 -m venv venv --clear
                source venv/bin/activate
                pip install --upgrade pip
                pip install -r requirements.txt
              else
                echo "DEBUG: Entorno virtual encontrado, activando..."
                source venv/bin/activate
              fi
              
              echo "DEBUG: Deteniendo procesos PM2 anteriores..."
              pm2 stop api || echo "DEBUG: No había proceso 'api' ejecutándose"
              pm2 delete api || echo "DEBUG: No había proceso 'api' para eliminar"
              
              # Reiniciar API con PM2
              echo "DEBUG: Iniciando API con PM2..."
              pm2 start app.py --name api --interpreter ./venv/bin/python3 --instances 1
              echo "DEBUG: Código de salida de PM2 start: $?"
              pm2 save
              
              # Verificar que la API esté funcionando
              echo "DEBUG: Verificando API..."
              sleep 3
              for i in {1..15}; do
                echo "DEBUG: Intento $i de verificación de API..."
                if curl -s http://localhost:3001/health > /dev/null 2>&1; then
                  echo "✓ Backend API funcionando correctamente"
                  echo "DEBUG: Respuesta de health check:"
                  curl -s http://localhost:3001/health
                  break
                fi
                echo "DEBUG: Esperando API... ($i/15)"
                if [ $i -eq 15 ]; then
                  echo "DEBUG: API no responde después de 15 intentos"
                  echo "DEBUG: Estado de PM2:"
                  pm2 status
                  echo "DEBUG: Logs de PM2:"
                  pm2 logs api --lines 10 || echo "DEBUG: No hay logs de PM2 disponibles"
                fi
                sleep 2
              done

              echo "[5] Recargando nginx..."
              echo "DEBUG: Validando configuración antes del reload final..."
              nginx -t && systemctl reload nginx
              echo "DEBUG: Código de salida del reload final: $?"

              echo "[6] Verificación final..."
              echo "DEBUG: Tests finales de Content-Type desde el servidor:"
              echo "DEBUG: sitemap.xml local:"
              curl -I http://localhost/sitemap.xml 2>/dev/null | head -10 || echo "DEBUG: Error en test local sitemap.xml"
              echo "DEBUG: robots.txt local:"
              curl -I http://localhost/robots.txt 2>/dev/null | head -10 || echo "DEBUG: Error en test local robots.txt"
              
              if curl -s http://localhost:3001/health > /dev/null 2>&1; then
                echo "✓ Backend accesible desde frontend"
              else
                echo "⚠ Warning: Backend no responde, verificar manualmente"
              fi

              echo "[OK] Frontend y backend actualizados correctamente."
