name: Deploy Frontend to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    # Esperar a que termine el backend si ambos se ejecutan
    needs: []

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy frontend via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
            host: ${{ secrets.VPS_HOST }}
            username: root
            key: ${{ secrets.VPS_SSH_KEY }}
            script: |
              set -e

              echo "[0] Esperando a que el backend esté completamente desplegado..."
              # Esperar señal del backend o timeout después de 5 minutos
              timeout=300
              elapsed=0
              while [ $elapsed -lt $timeout ]; do
                if [ -f /tmp/backend-deploy-complete ]; then
                  echo "Backend deployment detectado, continuando..."
                  break
                fi
                if curl -s http://localhost:3001/health > /dev/null 2>&1 || curl -s http://localhost:3001 > /dev/null 2>&1; then
                  echo "API del backend respondiendo, continuando..."
                  break
                fi
                echo "Esperando backend... ($elapsed/$timeout segundos)"
                sleep 10
                elapsed=$((elapsed + 10))
              done
              
              echo "[1] Preparando entorno Node..."
              # IMPORTANTE: exportar el PATH donde vive node/npm/pm2 en tu VPS
              export PATH=/root/.nvm/versions/node/v24.11.0/bin:$PATH

              echo "[2] Actualizando repo frontend en el VPS..."
              cd /var/app/frontend
              git pull origin main

              echo "[3] Instalando dependencias..."
              npm install

              echo "[4] Construyendo build de producción..."
              npm run build

              echo "[5] Revisando config de nginx..."
              nginx -t

              echo "[6] Recargando nginx..."
              systemctl reload nginx

              echo "[7] Verificando conectividad frontend-backend..."
              sleep 5
              # Test básico de conectividad
              if curl -s http://localhost:3001 > /dev/null 2>&1; then
                echo "✓ Backend accesible desde frontend"
              else
                echo "⚠ Warning: Backend no accesible, puede requerir intervención manual"
              fi

              echo "[8] Limpiando archivos temporales..."
              rm -f /tmp/backend-deploy-complete

              echo "[OK] Frontend actualizado y desplegado correctamente."
