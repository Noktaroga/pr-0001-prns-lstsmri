name: Deploy Frontend to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    # Esperar a que termine el backend si ambos se ejecutan
    needs: []

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy frontend via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
            host: ${{ secrets.VPS_HOST }}
            username: root
            key: ${{ secrets.VPS_SSH_KEY }}
            script: |
              set -e

              # Configurar PATH para Node.js, npm y PM2
              export PATH=/root/.nvm/versions/node/v24.11.0/bin:$PATH

              echo "[0] Gestionando backend durante deploy de frontend..."
              
              # Detener backend si está corriendo
              echo "Deteniendo backend API..."
              pm2 stop api || true
              pm2 delete api || true
              
              # Liberar puerto 3001
              echo "Liberando puerto 3001..."
              if lsof -i:3001 > /dev/null 2>&1; then
                lsof -ti:3001 | xargs kill -9 || true
                sleep 2
              fi

              echo "[1] Actualizando frontend..."
              cd /var/app/frontend
              git pull origin main

              echo "[2] Instalando dependencias..."
              npm install

              echo "[3] Construyendo build de producción..."
              npm run build

              echo "[4] Reiniciando backend API..."
              cd /var/app/backend
              
              # Verificar que el entorno virtual existe
              if [ ! -d "venv" ]; then
                echo "Entorno virtual no encontrado, creando..."
                python3 -m venv venv --clear
                source venv/bin/activate
                pip install --upgrade pip
                pip install -r requirements.txt
              else
                echo "Activando entorno virtual existente..."
                source venv/bin/activate
              fi
              
              # Reiniciar API con PM2
              echo "Iniciando API con PM2..."
              pm2 start app.py --name api --interpreter ./venv/bin/python3 --instances 1
              pm2 save
              
              # Verificar que la API esté funcionando
              echo "Verificando API..."
              sleep 3
              for i in {1..15}; do
                if curl -s http://localhost:3001/health > /dev/null 2>&1; then
                  echo "✓ Backend API funcionando correctamente"
                  break
                fi
                echo "Esperando API... ($i/15)"
                sleep 2
              done

              echo "[5] Recargando nginx..."
              nginx -t && systemctl reload nginx

              echo "[6] Verificación final..."
              if curl -s http://localhost:3001/health > /dev/null 2>&1; then
                echo "✓ Backend accesible desde frontend"
              else
                echo "⚠ Warning: Backend no responde, verificar manualmente"
              fi

              echo "[OK] Frontend y backend actualizados correctamente."
